import { Supadata } from '@supadata/js';
import OpenAI from 'openai';

// Initialize the clients
const supadata = new Supadata({
    apiKey: 'sd_cf39c3a6069af680097faf6f996b8c16'
});

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
});

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã batch job –∏–∑ Supadata, –∏–∑–≤–ª–µ–∫–∞–µ—Ç transcript –ø–æ–ª—è
 * –∏ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∑—é–º–µ —Å –ø–æ–º–æ—â—å—é OpenAI
 * 
 * @param {string} jobId - ID batch job –∏–∑ Supadata
 * @param {string} userQuery - –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ
 * @returns {Promise<Object>} –û–±—ä–µ–∫—Ç —Å —Ä–µ–∑—é–º–µ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
 */
async function getTranscriptSummary(jobId, userQuery) {
    try {
        console.log('üîç –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã batch job...');
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã batch job
        const batchResults = await supadata.youtube.batch.getBatchResults(jobId);
        
        if (batchResults.status !== 'completed') {
            throw new Error(`Batch job –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –°—Ç–∞—Ç—É—Å: ${batchResults.status}`);
        }
        
        console.log('‚úÖ Batch job –∑–∞–≤–µ—Ä—à–µ–Ω, –∏–∑–≤–ª–µ–∫–∞–µ–º transcript –ø–æ–ª—è...');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º transcript –ø–æ–ª—è –∏–∑ –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        const transcripts = batchResults.results
            .filter(result => result.transcript) // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Å transcript
            .map(result => result.transcript);
        
        if (transcripts.length === 0) {
            throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ transcript –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö');
        }
        
        console.log(`üìù –ù–∞–π–¥–µ–Ω–æ ${transcripts.length} transcript(–æ–≤)`);
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ transcript –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç
        const combinedTranscripts = transcripts.join('\n\n---\n\n');
        
        console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ OpenAI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ...');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ OpenAI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ
        const completion = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                {
                    role: 'system',
                    content: '–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–æ–∑–¥–∞–≤–∞–π –∫—Ä–∞—Ç–∫–∏–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—é–º–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –≤–∏–¥–µ–æ.'
                },
                {
                    role: 'user',
                    content: `–ó–∞–ø—Ä–æ—Å: ${userQuery}\n\n–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã:\n${combinedTranscripts}`
                }
            ],
            max_tokens: 2000,
            temperature: 0.7
        });
        
        const summary = completion.choices[0].message.content;
        console.log('‚úÖ –†–µ–∑—é–º–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
        
        return {
            summary,
            transcriptCount: transcripts.length,
            totalResults: batchResults.results.length,
            jobId,
            userQuery
        };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑—é–º–µ:', error.message);
        throw error;
    }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ transcript –ø–æ–ª—è –∏–∑ batch job –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ
 * 
 * @param {string} jobId - ID batch job –∏–∑ Supadata
 * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ transcript –ø–æ–ª–µ–π
 */
async function getTranscriptsOnly(jobId) {
    try {
        console.log('üîç –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã batch job...');
        
        const batchResults = await supadata.youtube.batch.getBatchResults(jobId);
        
        if (batchResults.status !== 'completed') {
            throw new Error(`Batch job –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –°—Ç–∞—Ç—É—Å: ${batchResults.status}`);
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ transcript –ø–æ–ª—è
        const transcripts = batchResults.results
            .filter(result => result.transcript)
            .map(result => result.transcript);
        
        console.log(`üìù –ù–∞–π–¥–µ–Ω–æ ${transcripts.length} transcript(–æ–≤)`);
        
        return transcripts;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ transcript:', error.message);
        throw error;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è ES modules
export { getTranscriptSummary, getTranscriptsOnly };

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è CommonJS
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { getTranscriptSummary, getTranscriptsOnly };
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é)
if (import.meta.url === `file://${process.argv[1]}`) {
    const jobId = process.argv[2] || 'aadd0959-70f3-46e4-bd1b-caa45f72b293';
    const userQuery = process.argv[3] || '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è –≤ —ç—Ç–∏—Ö –≤–∏–¥–µ–æ?';
    
    getTranscriptSummary(jobId, userQuery)
        .then(result => {
            console.log('\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:');
            console.log(`- –í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${result.totalResults}`);
            console.log(`- Transcript –Ω–∞–π–¥–µ–Ω–æ: ${result.transcriptCount}`);
            console.log('\nüìù –†–µ–∑—é–º–µ:');
            console.log(result.summary);
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
            process.exit(1);
        });
} —à 